name: Post Reddit Memes

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  post-meme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Fetch and Post Meme
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python3 << 'EOF'
          import requests
          import json
          import os
          import random
          import time
          
          DISCORD_WEBHOOK = os.environ.get('DISCORD_WEBHOOK')
          
          print("Fetching memes from Reddit RSS...")
          
          # Use Reddit RSS feed (harder to block)
          response = requests.get(
              'https://www.reddit.com/r/memes/.rss',
              headers={'User-Agent': 'PostmanRuntime/7.32.0'}
          )
          
          if response.status_code != 200:
              print(f"Failed to fetch: {response.status_code}")
              exit(0)
          
          # Parse RSS XML
          import xml.etree.ElementTree as ET
          root = ET.fromstring(response.content)
          
          entries = []
          for entry in root.findall('.//{http://www.w3.org/2005/Atom}entry'):
              title_elem = entry.find('{http://www.w3.org/2005/Atom}title')
              content_elem = entry.find('{http://www.w3.org/2005/Atom}content')
              link_elem = entry.find('{http://www.w3.org/2005/Atom}link')
              
              if title_elem is not None and content_elem is not None:
                  content = content_elem.text or ""
                  link = link_elem.get('href') if link_elem is not None else ""
                  
                  # Extract image URL from content
                  if 'i.redd.it' in content or 'i.imgur.com' in content:
                      import re
                      img_match = re.search(r'(https://i\.redd\.it/[^\s"<]+\.(jpg|png|gif))', content)
                      if not img_match:
                          img_match = re.search(r'(https://i\.imgur\.com/[^\s"<]+\.(jpg|png|gif))', content)
                      
                      if img_match:
                          entries.append({
                              'title': title_elem.text,
