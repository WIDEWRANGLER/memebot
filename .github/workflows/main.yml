name: Post Reddit Memes

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  post-meme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Fetch and Post Memes
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python3 << 'ENDOFPYTHON'
          import requests
          import os
          import time
          
          DISCORD_WEBHOOK = os.environ.get('DISCORD_WEBHOOK')
          
          # List of all subreddits
          subreddits = ['memes', 'cursedcomments', 'Dank', 'HolUp', 'darkfunny', 'rareinsults']
          
          print(f"Fetching memes from {len(subreddits)} subreddits...")
          
          posted_count = 0
          
          for subreddit in subreddits:
              try:
                  print(f"\n--- Fetching from r/{subreddit} ---")
                  
                  # Fetch meme from this subreddit
                  response = requests.get(f'https://meme-api.com/gimme/{subreddit}')
                  
                  if response.status_code != 200:
                      print(f"API error for r/{subreddit}: {response.status_code}")
                      continue
                  
                  data = response.json()
                  
                  title = data.get('title', 'No title')
                  image_url = data.get('url', '')
                  post_url = data.get('postLink', '')
                  
                  if not image_url:
                      print(f"No image found for r/{subreddit}")
                      continue
                  
                  print(f"Title: {title[:50]}...")
                  print(f"Image: {image_url}")
                  
                  # Post to Discord
                  payload = {
                      "embeds": [{
                          "title": title[:256],
                          "url": post_url,
                          "image": {"url": image_url},
                          "color": 16761035,
                          "footer": {"text": f"From r/{subreddit}"}
                      }]
                  }
                  
                  discord_response = requests.post(DISCORD_WEBHOOK, json=payload)
                  
                  if discord_response.status_code in [200, 204]:
                      print(f"✓ Posted from r/{subreddit}")
                      posted_count += 1
                  else:
                      print(f"✗ Discord error for r/{subreddit}: {discord_response.status_code}")
                  
                  # Small delay between posts to avoid rate limiting
                  time.sleep(1)
                  
              except Exception as e:
                  print(f"Error with r/{subreddit}: {str(e)}")
                  continue
          
          print(f"\n=== SUMMARY: Posted {posted_count}/{len(subreddits)} memes ===")
          
          ENDOFPYTHON
