name: Post Reddit Memes

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  post-meme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Fetch and Post Meme
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python3 << 'EOF'
          import requests
          import json
          import os
          import random
          
          DISCORD_WEBHOOK = os.environ.get('DISCORD_WEBHOOK')
          
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
          }
          
          print("Fetching memes from Reddit...")
          response = requests.get(
              'https://www.reddit.com/r/memes/hot.json?limit=20',
              headers=headers
          )
          
          if response.status_code != 200:
              print(f"Reddit returned status code: {response.status_code}")
              exit(0)
          
          data = response.json()
          posts = data['data']['children']
          
          # Filter for image posts only
          image_posts = []
          for post in posts:
              url = post['data']['url']
              if url.endswith(('.jpg', '.jpeg', '.png', '.gif')) or 'i.redd.it' in url:
                  image_posts.append(post['data'])
          
          if not image_posts:
              print("No image posts found")
              exit(0)
          
          # Pick a random meme
          meme = random.choice(image_posts)
          
          title = meme['title']
          image_url = meme['url']
          post_url = f"https://reddit.com{meme['permalink']}"
          
          print(f"Title: {title}")
          print(f"Image: {image_url}")
          
          # Post to Discord
          payload = {
              "embeds": [{
                  "title": title[:256],  # Discord limit
                  "url": post_url,
                  "image": {"url": image_url},
                  "color": 16761035,
                  "footer": {"text": "From r/memes"}
              }]
          }
          
          print("Posting to Discord...")
          discord_response = requests.post(DISCORD_WEBHOOK, json=payload)
          
          print(f"Discord status code: {discord_response.status_code}")
          if discord_response.status_code in [200, 204]:
              print("✓ Successfully posted meme!")
          else:
              print(f"✗ Error: {discord_response.text}")
          
          EOF
