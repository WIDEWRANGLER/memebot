name: Post Reddit Memes

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  post-meme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Fetch and Post Meme
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python3 << 'ENDOFPYTHON'
          import requests
          import os
          import random
          
          DISCORD_WEBHOOK = os.environ.get('DISCORD_WEBHOOK')
          
          print("Fetching memes from meme API...")
          
          # Use a meme API that aggregates from Reddit
          response = requests.get('https://meme-api.com/gimme/memes/50')
          
          if response.status_code != 200:
              print(f"API error: {response.status_code}")
              exit(0)
          
          data = response.json()
          memes = data.get('memes', [])
          
          if not memes:
              print("No memes found")
              exit(0)
          
          # Pick a random meme
          meme = random.choice(memes)
          
          title = meme['title']
          image_url = meme['url']
          post_url = meme['postLink']
          
          print(f"Title: {title}")
          print(f"Image: {image_url}")
          
          # Post to Discord
          payload = {
              "embeds": [{
                  "title": title[:256],
                  "url": post_url,
                  "image": {"url": image_url},
                  "color": 16761035,
                  "footer": {"text": "From r/memes"}
              }]
          }
          
          print("Posting to Discord...")
          discord_response = requests.post(DISCORD_WEBHOOK, json=payload)
          
          print(f"Discord status: {discord_response.status_code}")
          
          if discord_response.status_code in [200, 204]:
              print("✓ Meme posted successfully!")
          else:
              print(f"✗ Discord error: {discord_response.text}")
          
          ENDOFPYTHON
