name: Post Reddit Memes

on:
  schedule:
    - cron: '0 */8 * * *'
  workflow_dispatch:

jobs:
  post-meme:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch and Post Memes
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python3 << 'EOF'
          import requests
          import os
          import json
          import time

          DISCORD_WEBHOOK = os.environ.get("DISCORD_WEBHOOK")
          FILE = "posted_memes.json"
          SUBREDDITS = ["memes", "cursedcomments", "animememes", "rareinsults", "IndianDankMemes"]

          try:
              with open(FILE, "r") as f:
                  posted = set(json.load(f))
          except:
              posted = set()

          for subreddit in SUBREDDITS:
              try:
                  r = requests.get(f"https://meme-api.com/gimme/{subreddit}", timeout=10)
                  if r.status_code != 200:
                      continue

                  data = r.json()
                  link = data.get("postLink")
                  if not link:
                      continue

                  post_id = link.split("/")[-2]
                  if post_id in posted:
                      continue

                  payload = {
                      "embeds": [{
                          "title": data.get("title", "")[:256],
                          "url": link,
                          "image": {"url": data.get("url", "")},
                          "footer": {"text": f"From r/{subreddit}"}
                      }]
                  }

                  d = requests.post(DISCORD_WEBHOOK, json=payload, timeout=10)
                  if d.status_code in (200, 204):
                      posted.add(post_id)

                  time.sleep(1)

              except:
                  continue

          with open(FILE, "w") as f:
              json.dump(list(posted)[-1000:], f)

          EOF

      - name: Commit changes
        run: |
          git config user.name github-actions
          git config user.email actions@github.com
          git add posted_memes.json
          git commit -m "update meme history" || echo "no changes"
          git push
